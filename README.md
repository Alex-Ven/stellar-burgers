# Stellar Burgers

Проект **Stellar Burgers** — это веб-приложение для создания и управления заказами в ресторане космической бургерной. Пользователи могут просматривать и выбирать ингредиенты, делать заказы, редактировать свои данные и просматривать историю заказов. Приложение также включает функционал для отображения текущих заказов в реальном времени и работы с профилем пользователя.

[Макет](https://www.figma.com/file/vIywAvqfkOIRWGOkfOnReY/React-Fullstack_-Проектные-задачи-(3-месяца)_external_link?type=design&node-id=0-1&mode=design)  
[Чеклист](https://www.notion.so/praktikum/0527c10b723d4873aa75686bad54b32e?pvs=4)

## Функциональные требования

### Редактирование данных пользователя
- **Редактирование профиля**: Пользователь может изменить свои данные. После изменений появляется кнопки "Сохранить" и "Отмена". При нажатии на "Сохранить" отправляется запрос на сервер с новыми данными, при "Отмене" данные восстанавливаются.
- **Шапка навигации**: Ссылка, на которой находится пользователь, остаётся активной даже на вложенных маршрутах.
- **История заказов**: Экран `/profile/orders` доступен только авторизованным пользователям и отображает историю заказов.
- **Модальное окно ингредиента**: При клике на ингредиент открывается модальное окно с его описанием.

### Экран «Конструктор бургера»

- **Доступность**: Экран доступен всем пользователям по маршруту `/`.
- **Ингредиенты**: 
  - Список ингредиентов загружается с сервера.
  - При клике на ингредиент открывается модальное окно с его детальным описанием.
  - При нажатии кнопки «Добавить» ингредиент добавляется в конструктор бургера.
- **Булки**:
  - Можно выбрать только одну булку, которая отображается в верхней и нижней части создаваемого бургера.
  - При добавлении другой булки она заменяет ранее выбранную.
- **Начинки и соусы**: 
  - Добавленные начинки и соусы отображаются в центральной части бургера.
- **Удаление ингредиентов**:
  - При клике на кнопку удаления ингредиент удаляется из конструктора.
  - Выбранную булку нельзя удалить, её можно только заменить.
- **Счётчики ингредиентов**:
  - Для каждого добавленного ингредиента отображается счётчик, который увеличивается при добавлении и уменьшается при удалении.
- **Стоимость бургера**:
  - Стоимость бургера подсчитывается динамически в зависимости от добавленных ингредиентов.
- **Оформление заказа**:
  - Только авторизованные пользователи могут оформлять заказы.
  - При попытке оформить заказ неавторизованным пользователем, он перенаправляется на страницу входа.
  - При оформлении заказа отправляется запрос к API с массивом `_id` добавленных ингредиентов и токеном авторизованного пользователя в заголовке.
  - После успешного оформления заказа отображается модальное окно с данными заказа.
  - После оформления заказа конструктор очищается от добавленных ингредиентов.


### Экран «Лента заказов»
- **Доступность**: Экран доступен всем пользователям по маршруту `/feed`.
- **Обновление в реальном времени**: Лента обновляется при создании нового заказа авторизованным пользователем.
- **Общее количество заказов**: Экран отображает общее количество заказов, а также количество заказов за текущий день.

### Экран «История заказов»
- **Доступность**: Экран доступен только авторизованным пользователям по маршруту `/profile/orders`.
- **Обновление в реальном времени**: Экран обновляется в реальном времени, отображая статусы заказов: «Отменён», «Готовится», «Выполнен».

### Роутинг
Для маршрутизации используется библиотека **react-router-dom**. Настроены следующие маршруты:

- `/` — Главная страница (ConstructorPage)
- `/feed` — Лента заказов (Feed)
- `/login` — Страница входа (Login)
- `/register` — Страница регистрации (Register)
- `/forgot-password` — Страница восстановления пароля (ForgotPassword)
- `/reset-password` — Страница сброса пароля (ResetPassword)
- `/profile` — Профиль пользователя (Profile)
- `/profile/orders` — История заказов (ProfileOrders)
- `/feed/:number` — Модальное окно с информацией о заказе (OrderInfo)
- `/ingredients/:id` — Модальное окно с описанием ингредиента (IngredientDetails)
- `/profile/orders/:number` — Модальное окно с информацией о заказе (OrderInfo)
- `*` — Неизвестный маршрут (NotFound404)

## Технологии

Для реализации проекта использованы следующие технологии:

- **React** — для создания динамичного пользовательского интерфейса. React позволяет строить компоненты, которые можно легко обновлять в ответ на изменения состояния.
- **TypeScript** — для статической типизации. TypeScript помогает избежать ошибок в коде на стадии компиляции, улучшая поддержку кода и облегчая рефакторинг.
- **Redux** — для управления состоянием приложения. Redux позволяет централизованно хранить состояние и эффективно взаимодействовать с компонентами приложения.
- **React Router** — для организации маршрутизации. Библиотека React Router позволяет легко управлять навигацией между экранами в приложении.
- **CSS Modules** — для стилизации компонентов. CSS Modules помогает избежать конфликтов имен классов и гарантирует, что стили будут применяться только в пределах соответствующего компонента.

## API

Приложение взаимодействует с сервером через следующие эндпоинты:

#### Получение ингредиентов
- **Метод**: GET  
- **URL**: `/ingredients`  
- **Описание**: Получает список всех доступных ингредиентов для создания бургеров.

#### Получение ленты заказов
- **Метод**: GET  
- **URL**: `/orders/all`  
- **Описание**: Получает все заказы.

#### Получение заказов пользователя
- **Метод**: GET  
- **URL**: `/orders`  
- **Описание**: Получает заказы авторизованного пользователя.

#### Создание нового заказа
- **Метод**: POST  
- **URL**: `/orders`  
- **Описание**: Создаёт новый заказ на основе выбранных ингредиентов.

#### Регистрация пользователя
- **Метод**: POST  
- **URL**: `/auth/register`  
- **Описание**: Регистрирует нового пользователя.

#### Авторизация пользователя
- **Метод**: POST  
- **URL**: `/auth/login`  
- **Описание**: Выполняет вход пользователя.

#### Получение информации о пользователе
- **Метод**: GET  
- **URL**: `/auth/user`  
- **Описание**: Получает информацию о текущем пользователе.

#### Обновление данных пользователя
- **Метод**: PATCH  
- **URL**: `/auth/user`  
- **Описание**: Обновляет данные текущего пользователя.

#### Выход пользователя
- **Метод**: POST  
- **URL**: `/auth/logout`  
- **Описание**: Выход пользователя из системы.

## Установка и запуск

1. Клонирование репозитория
git clone <ссылка_на_репозиторий>
cd <имя_репозитория>

2. Установка зависимостей
npm install

3. Запуск приложения в режиме разработки
npm start

4. Сборка проекта в продакшн-режиме
npm run build

## Запросы к серверу с Redux

### Настройка Redux

Для управления состоянием в проекте используется **Redux**. Запросы к серверу прописаны в файле `utils/burger-api.ts`, а для работы с состоянием Redux используется подход с асинхронными экшенами с помощью **createSlice** и **Thunk**.

- Создан **RootReducer** и подключён к **store**.
- Созданы **слайсы** с помощью **createSlice**, описаны редюсеры для сохранения данных в store.

**Асинхронные Thunk-функции**:
- Использованы асинхронные функции для отправки запросов к серверу.
- Для обработки успешных запросов и ошибок обновляется состояние в редюсерах.
- Использованы лоадеры для отображения состояния загрузки данных на экране.

Весь код, описывающий работу с Redux, расположен в папке `services`.

---

## Тестирование

Проект включает интеграционные тесты с использованием **Cypress** и юнит-тесты с использованием **Jest**.

### Cypress (Интеграционные тесты)

#### Тестирование страницы конструктора

**Описание тестов**

Для обеспечения корректной работы страницы конструктора бургера были написаны интеграционные тесты с использованием **Cypress**. Эти тесты проверяют основные функциональные особенности страницы конструктора, включая добавление булочек, основных ингредиентов и соусов.

**Структура тестов**

В файле `constructor.cy.tsx` мы определяем несколько тестов, которые автоматически выполняются при запуске тестов. Каждый тест представляет собой последовательность действий пользователя и проверяет, что интерфейс работает правильно.

**Сценарии тестирования**:

- **Мокинг данных ингредиентов**: для тестирования был создан файл с моковыми данными — `ingredients.json`. При каждом запросе к эндпоинту `/api/ingredients` эти данные используются, что позволяет нам тестировать функциональность без необходимости взаимодействовать с реальной базой данных.
- **Тест добавления булочек в конструктор**:
  - Проверяется, что булочки не отображаются в конструкторе до клика по кнопке "Добавить".
  - После нажатия кнопки булочки (верхняя и нижняя) должны появиться в конструкторе.
  - Селекторы для проверки булочек: `top_bun_constructor`, `bottom_bun_constructor`.
- **Тест добавления ингредиентов и соусов в конструктор**:
  - Проверяется, что начинки (например, куриное филе) и соус (например, чесночный соус) отсутствуют до клика по кнопке "Добавить".
  - После нажатия кнопки "Добавить" проверяется, что эти ингредиенты появляются в списке конструктора.
  - Селекторы для проверки ингредиентов: `ingredients_main`, `ingredients_sauce`.

**Подробности тестирования**:

- **Мокирование запросов**: Для имитации запросов к серверу мы используем функцию `cy.intercept()`, которая перехватывает запросы к эндпоинту `/api/ingredients` и подставляет фикстуры (моковые данные), хранящиеся в файле `ingredients.json`.
- **Проверка добавления булочек и ингредиентов**: Тесты на добавление ингредиентов проверяют, что булочки, начинки и соусы корректно отображаются в конструкторе при их добавлении. Они сначала отсутствуют, а после клика по кнопке "Добавить" — появляются.
- **Асинхронные ожидания**: Перед каждым тестом мы гарантируем, что запросы на сервер завершены с помощью `cy.wait()`, что исключает асинхронные ошибки и делает тесты более надежными.

**Заключение**:

Эти тесты с Cypress обеспечивают базовую проверку функциональности конструктора бургера. Они гарантируют, что добавление ингредиентов, булочек и соусов происходит корректно, а также что интерфейс правильно реагирует на действия пользователя. Это помогает избежать ошибок при изменении или добавлении новых функций на страницу конструктора.

#### Тестирование модальных окон

**Описание тестов**

В рамках тестирования функционала модальных окон на странице конструктора бургера, были написаны тесты с использованием **Cypress**. Эти тесты проверяют основные действия с модальными окнами, такие как их открытие и закрытие, а также взаимодействие с различными элементами, связанными с модальными окнами.

**Структура тестов**

В файле `modal.cy.tsx` определены тесты, которые проверяют различные сценарии взаимодействия с модальными окнами. Каждый тест включает серию действий, например, клик по ингредиентам, открытие модального окна и последующее его закрытие как с помощью кнопки закрытия, так и с помощью клика по оверлею.

**Сценарии тестирования**:

- **Тест открытия модального окна при клике на ингредиент**: проверяется, что модальное окно открывается при клике по элементу ингредиента (например, булке). Модальное окно должно содержать название выбранного ингредиента.
- **Тест закрытия модального окна кнопкой "Закрыть"**: проверяется, что модальное окно закрывается при клике на кнопку закрытия (крестик).
- **Тест закрытия модального окна кликом по оверлею**: проверяется, что модальное окно закрывается, если пользователь кликает на оверлей (область вокруг модального окна).

**Подробности тестирования**:

- **Мокирование запросов**: Для имитации запросов на получение данных ингредиентов используется функция `cy.intercept()`, которая перехватывает запросы к эндпоинту `/api/ingredients` и подставляет фикстуры (моковые данные), хранящиеся в файле `ingredients.json`.
- **Проверка открытия модального окна**: После клика по ингредиенту (например, булке), проверяется, что модальное окно открылось и отображает правильное содержимое, соответствующее выбранному ингредиенту.
- **Проверка закрытия модального окна**: Для закрытия модального окна тестируются два способа:
  - Клик по кнопке закрытия (`modal-close-btn`).
  - Клик по оверлею (`modal-overlay`).

**Заключение**:

Эти тесты обеспечивают проверку основных сценариев работы с модальными окнами на странице конструктора бургера. Тестируется правильность открытия модальных окон, отображение соответствующего контента, а также корректность закрытия окон как с помощью кнопки, так и кликом по оверлею. Это важная функциональность для удобства взаимодействия с пользователем, и её тестирование помогает гарантировать стабильность работы интерфейса.

#### Тестирование создания заказа

**Описание тестов**

Тесты, описанные в этом разделе, предназначены для проверки функционала создания заказа на странице конструктора бургера. Они охватывают действия пользователя, такие как добавление ингредиентов в конструктор, оформление заказа и проверку успешного завершения процесса. Тесты также проверяют поведение интерфейса после оформления заказа, включая очищение конструктора и корректную работу модальных окон.

**Структура тестов**

В файле `order.cy.tsx` описаны тесты, которые проверяют процесс создания заказа и реакции интерфейса на действия пользователя. Включены тесты для добавления ингредиентов в конструктор, клика на кнопку "Оформить заказ", проверки модального окна с номером заказа и очистки конструктора после оформления заказа.

**Сценарии тестирования**:

- **Тест добавления ингредиентов и успешного создания заказа**:
  - Добавляются ингредиенты в конструктор (булка, мясо, соус).
  - Кликается кнопка "Оформить заказ".
  - Проверяется, что запрос на создание заказа прошел успешно, и номер заказа отображается в модальном окне.
  - После оформления заказа проверяется, что модальное окно закрылось и конструктор очищен от ингредиентов.
- **Проверка очистки конструктора после оформления заказа**:
  - После оформления заказа и закрытия модального окна проверяется, что все ингредиенты были удалены из конструктора.

**Подробности тестирования**:

- **Мокирование запросов**: Для имитации запросов на получение данных ингредиентов, информации о пользователе и создания заказа используется функция `cy.intercept()`. В ответах используются фикстуры (моковые данные), такие как `ingredients.json`, `user.json` и `order.json`.
- **Добавление ингредиентов и создание заказа**: В этом тесте добавляются ингредиенты в конструктор (булка, мясо и соус). Затем кликается кнопка "Оформить заказ", после чего отправляется запрос на создание заказа. Ожидается, что ответ будет успешным (код состояния 200), и номер заказа будет корректным.
- **Проверка модального окна и очистки конструктора**: После оформления заказа проверяется, что модальное окно с номером заказа открылось. Затем оно закрывается, и проверяется, что конструктор очищен от ингредиентов, которые были добавлены ранее.

**Заключение**:

Эти тесты гарантируют, что процесс оформления заказа работает корректно. Тестируется не только успешное создание заказа, но и то, что происходит с интерфейсом после его оформления — конструктор очищается, и модальное окно с номером заказа появляется.

### Юнит-тесты (Jest):

Юнит-тесты проверяют функциональность отдельных частей приложения — обычно это функции, редюсеры и асинхронные действия (например, запросы к серверу). Юнит-тесты помогают убедиться, что:

- Редюсеры работают корректно, например, правильно добавляют и удаляют ингредиенты в состоянии приложения.
- Асинхронные действия корректно обрабатывают данные, например, при запросе ингредиентов с сервера, и правильно обновляют состояние.
  
Эти тесты позволяют нам убедиться в правильности работы внутренних компонентов и минимизируют риск возникновения ошибок в отдельных частях системы, что повышает устойчивость приложения.

---

#### Тестирование редьюсера `burgerSlice`

**Описание тестов**:
Тесты в этом разделе проверяют корректность работы редьюсера `burgerSlice`, который отвечает за управление состоянием конструктора бургера. Включены тесты для добавления ингредиентов, удаления, перемещения и работы с булками. Эти тесты помогают гарантировать, что действия с ингредиентами выполняются корректно и что состояние конструктора бургера всегда обновляется в соответствии с действиями пользователя.

**Структура тестов**:
В файле `burgerSlice.test.ts` описаны тесты для редьюсера, который управляет состоянием конструктора бургера. Основные сценарии тестирования включают:

- Добавление ингредиентов в конструктор.
- Замена булки при добавлении булочного ингредиента.
- Удаление ингредиента по его ID.
- Перемещение ингредиентов внутри списка.
- Обработка некорректных индексов при попытке перемещения ингредиента.

**Сценарии тестирования**:

- **Тест добавления ингредиента**: Проверяется, что при добавлении ингредиента в конструктор (например, соуса), он появляется в состоянии конструктора.
  
- **Тест замены булки**: При добавлении булки в конструктор проверяется, что булка заменяет все предыдущие ингредиенты, а список ингредиентов очищается.
  
- **Тест удаления ингредиента**: Проверяется, что ингредиент можно удалить из конструктора по его ID. После удаления остаются только другие ингредиенты.
  
- **Тест перемещения ингредиента**: Проверяется, что ингредиент можно переместить внутри списка ингредиентов. Ожидается, что порядок элементов будет изменен корректно.
  
- **Тест с некорректными индексами при перемещении ингредиента**: Проверяется, что если индексы для перемещения выходят за пределы допустимых значений, ингредиент не перемещается.

**Заключение**:
Эти тесты гарантируют, что редьюсер `burgerSlice` работает корректно при добавлении, удалении и перемещении ингредиентов. Также тестируется правильная обработка добавления булки, которая очищает список других ингредиентов. Тесты помогают убедиться, что состояние конструктора бургера обновляется в соответствии с действиями пользователя, а логика работы редьюсера работает правильно.

---

#### Тестирование редьюсера `feedSlice`

**Описание тестов**:
В этом разделе описаны тесты для редьюсера `feedSlice`, который управляет состоянием данных о заказах (`feeds`). Эти тесты обеспечивают корректную обработку состояний загрузки и ошибок при запросах, а также проверяют правильность обновления состояния после успешной загрузки данных и при отклонении запроса.

**Структура тестов**:
Тесты охватывают несколько сценариев:

- Установка состояния `isLoading` в `true` и сброс ошибки при запуске запроса.
- Обновление состояния с заказами после успешного запроса.
- Обработка ошибок при неудачной попытке загрузки данных.
- Установка заказа в `selectedModalOrder` после успешного запроса по номеру заказа.

**Сценарии тестирования**:

- **Тест на установку состояния `isLoading` в true и сброс ошибки**: При запуске запроса для получения данных о заказах проверяется, что состояние `isLoading` становится равным `true`, а ошибка сбрасывается.
  
- **Тест на успешную загрузку данных**: При успешной загрузке данных проверяется, что состояние обновляется с полученными заказами, а флаг `isLoading` сбрасывается.
  
- **Тест на установку ошибки при неудачной загрузке**: При ошибке в процессе запроса состояние обновляется с ошибкой и флагом `isLoading` в `false`.
  
- **Тест на установку состояния `isLoading` в true при запросе заказа по номеру**: При запросе одного заказа по номеру проверяется, что состояние `isLoading` становится равным `true`.
  
- **Тест на успешное получение заказа по номеру**: При успешном запросе заказа по номеру проверяется, что состояние обновляется, и заказ сохраняется в `selectedModalOrder`.
  
- **Тест на установку ошибки при отклонении запроса заказа по номеру**: При неудачной попытке получения заказа по номеру проверяется, что ошибка сохраняется, а флаг `isLoading` сбрасывается.

**Заключение**:
Тесты гарантируют, что редьюсер `feedSlice` корректно управляет состоянием заказов при загрузке данных о заказах и при запросах по номеру заказа. Эти тесты покрывают как успешные сценарии, так и обработку ошибок, что помогает поддерживать стабильность и надежность работы системы.

---

#### Тестирование редьюсера `ingredientsSlice`

**Описание тестов**:
В этом разделе описаны тесты для редьюсера `ingredientsSlice`, который управляет состоянием ингредиентов для конструктора бургера. Эти тесты охватывают корректную обработку состояния загрузки, успешных запросов и ошибок, возникающих при попытке загрузки ингредиентов.

**Структура тестов**:
Тесты проверяют несколько ключевых сценариев:

- Установка состояния `loading` в `true` и сброс ошибки при запросе.
- Обновление состояния с ингредиентами после успешного запроса.
- Обработка ошибки при неудачной попытке загрузки данных о ингредиентах.

**Сценарии тестирования**:

- **Тест на установку состояния `loading` в true и сброс ошибки при запросе**: При начале запроса ингредиентов проверяется, что состояние `loading` становится равным `true`, а ошибка сбрасывается.
  
- **Тест на успешную загрузку ингредиентов**: При успешной загрузке ингредиентов проверяется, что состояние обновляется с полученными ингредиентами, а флаг `loading` сбрасывается в `false`.
  
- **Тест на установку ошибки при неудачной загрузке ингредиентов**: При ошибке в процессе запроса ингредиентов проверяется, что состояние обновляется с ошибкой и флагом `loading` в `false`.

**Заключение**:
Тесты для редьюсера `ingredientsSlice` проверяют, что состояние ингредиентов обновляется корректно в разных ситуациях: при запуске запроса, при успешной загрузке данных и при ошибке. Эти тесты обеспечивают правильное поведение компонента и предотвращают потенциальные ошибки в процессе взаимодействия с API для получения ингредиентов.

---

#### Тестирование редьюсера `userSlice`

**Описание тестов**:
В этом разделе описаны тесты для редьюсера `userSlice`, который управляет состоянием пользователя, аутентификацией и действиями, связанными с пользователем, такими как вход, регистрация, обновление данных, выход, и управление заказами. Тесты проверяют правильную обработку состояний при выполнении различных экшенов, таких как запросы на авторизацию, регистрацию, обновление пользователя, восстановление пароля и т.д.

**Структура тестов**:
Тесты проверяют различные сценарии для экшенов:

- Авторизация и регистрация пользователя.
- Обновление данных пользователя.
- Выход пользователя.
- Восстановление пароля и сброс пароля.
- Получение списка заказов.

**Сценарии тестирования**:

- **Тест на проверку аутентификации пользователя**: При проверке аутентификации (`checkUserAuth`) проверяется, что флаги статуса и ошибки обновляются корректно в зависимости от состояния запроса (`pending`, `fulfilled`, `rejected`).
  
- **Тесты на вход и регистрацию пользователя**: При успешном входе или регистрации пользователь авторизуется, а его данные сохраняются в состоянии. В случае ошибки в процессе входа или регистрации проверяется корректное обновление состояния с ошибкой.
  
- **Тесты на обновление данных пользователя**: При успешном обновлении данных пользователя в состоянии сохраняются новые данные.
  
- **Тесты на выход пользователя**: При выходе пользователя из системы его данные очищаются, а флаг авторизации сбрасывается.
  
- **Тесты на обработку заказов**: При запросе заказов флаг загрузки обновляется, а сами заказы сохраняются в состоянии при успешном ответе.
  
- **Тесты на восстановление и сброс пароля**: При запросе восстановления пароля и сброса пароля проверяется изменение состояния в зависимости от результата запроса.

**Заключение**:
Эти тесты обеспечивают покрытие всех ключевых операций, которые выполняются с состоянием пользователя, и обеспечивают уверенность в корректности редьюсера.

#### Тестирование `rootReducer`

**Описание тестов**:

В данном тесте мы проверяем начальное состояние Redux хранилища при запуске приложения. Для этого создается тестовый экшен с типом `UNKNOWN_ACTION` и проверяется, что при передаче `undefined` в качестве начального состояния редьюсер возвращает корректное начальное состояние.

**Структура тестов**:

Редьюсер управляет состоянием нескольких слайсов:

- **burgerconstructor**: содержит информацию о бургере, его ингредиентах, ошибках и статусе загрузки.
- **feed**: отвечает за заказы в ленте, включая информацию о текущем заказе, ошибках и статусах загрузки.
- **ingredients**: хранит список ингредиентов и их загрузку.
- **user**: управляет состоянием пользователя, включая авторизацию и данные о заказах.

**Ожидаемое поведение теста**:

Тест проверяет, что при вызове редьюсера с `undefined` состоянием и несуществующим экшеном (`UNKNOWN_ACTION`) возвращается начальное состояние с установленными значениями по умолчанию для всех слайсов.

**Заключение**:

Тестирование начального состояния `rootReducer` является важной частью проверки корректности работы Redux хранилища в приложении. В данном тесте мы убедились, что при инициализации состояния с неопределенным значением редьюсер правильно возвращает начальное состояние, соответствующее ожиданиям.

Такой подход помогает гарантировать, что приложение будет работать корректно, начиная с правильной инициализации хранилища, независимо от того, был ли вызван конкретный экшен. Это важно для предотвращения ошибок в логике работы с состоянием на старте приложения.

